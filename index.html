<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>IoT Dashboard - Control Panel</title>
  <meta name="description" content="IoT Dashboard - Create and manage your IoT control panels with real-time monitoring and device control">
  
  <!-- External Stylesheets -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/gridstack@10.3.0/dist/gridstack.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  
  <!-- External Scripts -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/gridstack@10.3.0/dist/gridstack-all.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #ffffff; }

    /* --- SCREEN 1: LIST STYLES --- */
    .dash-card {
        background: white; border: 1px solid #e2e8f0; border-radius: 12px;
        padding: 24px; cursor: pointer; transition: all 0.2s;
        display: flex; flex-direction: column; justify-content: space-between;
        height: 180px; position: relative; overflow: hidden;
    }
    .dash-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #dc2626; }
    .dash-card .bg-icon { position: absolute; right: -20px; bottom: -20px; font-size: 100px; color: #f1f5f9; transform: rotate(-15deg); transition: 0.2s; }
    .dash-card:hover .bg-icon { color: #fee2e2; }

    /* --- SCREEN 2: WORKSPACE STYLES (V5.0) --- */
    .grid-stack-item-content {
      background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex; flex-direction: column; overflow: hidden;
      border: 1px solid #e2e8f0; height: 100% !important; 
    }
    body.edit-mode .grid-stack-item-content { border: 2px dashed #94a3b8; cursor: move; }
    .widget-header { height: 36px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; background: #fff; flex-shrink: 0; }
    .widget-title { font-weight: 600; font-size: 12px; color: #475569; text-transform: uppercase; }
    .edit-tools { display: none; gap: 8px; align-items: center; }
    body.edit-mode .edit-tools { display: flex !important; }
    .widget-header { position: relative; }
    .edit-tools button { cursor: pointer; transition: all 0.2s; }
    .edit-tools button:hover { transform: scale(1.1); }
    .widget-body { flex: 1; min-height: 0; width: 100%; height: 100%; position: relative; overflow: hidden; container-type: size; }

    /* Widget Internals */
    .led-bulb { width: 24px; height: 24px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #f1f5f9, #cbd5e1); box-shadow: inset 0 2px 5px rgba(0,0,0,0.2), 0 1px 1px rgba(255,255,255,0.5); border: 1px solid #94a3b8; transition: all 0.2s; }
    .led-on { background: radial-gradient(circle at 30% 30%, #ff8888, #ef4444); box-shadow: 0 0 10px #ef4444, 0 0 20px #ef4444, inset 0 2px 5px rgba(255,255,255,0.4); border-color: #b91c1c; }
    .btn-push { background: linear-gradient(to bottom, #f8fafc, #e2e8f0); box-shadow: 0 4px 0 #94a3b8; transition: 0.1s; transform: translateY(0); }
    .btn-push:active, .btn-active-state { transform: translateY(4px); box-shadow: none; background: #e2e8f0; }
    .btn-active-color { background: linear-gradient(to bottom, #4ade80, #22c55e) !important; color: white !important; }
    .tact-btn { background: radial-gradient(circle, #f1f5f9, #cbd5e1); box-shadow: 4px 4px 8px #bebebe, -4px -4px 8px #ffffff; transition: 0.1s; }
    .tact-btn:active { box-shadow: inset 4px 4px 8px #bebebe, inset -4px -4px 8px #ffffff; }
    .lcd-screen { background-color: #1e293b; color: #4ade80; font-family: 'JetBrains Mono', monospace; border: 2px solid #334155; border-radius: 4px; text-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }
    .terminal-log { font-family: 'JetBrains Mono', monospace; font-size: 10px; padding: 8px; background: #0f172a; color: #22c55e; height: 100%; overflow-y: auto; }

    /* Modal */
    #config-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal-content { background: white; width: 320px; border-radius: 12px; padding: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .form-group { margin-bottom: 12px; }
    .form-label { display: block; font-size: 11px; font-weight: 600; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
    .form-input { width: 100%; border: 1px solid #cbd5e1; border-radius: 6px; padding: 6px 10px; font-size: 13px; }
    .filter-tab { transition: all 0.2s; }
    .filter-tab.active { border-bottom: 2px solid #dc2626; }
  </style>
</head>
<body class="h-screen overflow-hidden text-slate-800">

  <div id="screen-list" class="h-full w-full flex flex-col bg-white">
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
      <nav class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-red-600 rounded flex items-center justify-center">
            <i class="ph ph-sliders text-white text-lg"></i>
          </div>
          <span class="text-xl font-bold text-slate-900">IoT Dashboard</span>
        </div>
        <div class="hidden md:flex items-center gap-8">
          <a href="home.html" class="text-slate-700 hover:text-red-600 font-medium transition">Home</a>
          <a href="features.html" class="text-slate-700 hover:text-red-600 font-medium transition">Features</a>
          <a href="index.html" class="text-red-600 bg-red-50 px-3 py-1 rounded font-medium transition">My Panels</a>
          <a href="contact.html" class="text-slate-700 hover:text-red-600 font-medium transition">Contact</a>
          <a href="login.html" class="ml-4 inline-flex items-center justify-center px-4 py-2 rounded-lg text-sm font-semibold bg-red-600 text-white hover:bg-red-700 transition shadow-sm">
            Login
          </a>
        </div>
      </nav>
    </header>

    <div class="flex-1 overflow-y-auto p-8">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">My Panels</h1>
                    <p class="text-slate-500 text-sm">Manage your IoT dashboards</p>
                </div>
                <button onclick="createNewDashboard()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-sm flex items-center gap-2 text-sm font-medium transition">
                    <i class="ph ph-plus text-base"></i> Create New Panel
                </button>
            </div>

            <div class="flex gap-3 mb-6">
                <div class="flex-1 relative">
                    <input type="text" placeholder="Search panels..." class="w-full px-4 py-2 pl-10 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                </div>
                <button class="px-4 py-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 transition">
                    Filter
                </button>
            </div>

            <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <div id="loading-state" class="col-span-full flex flex-col items-center justify-center py-20">
                    <div class="relative w-16 h-16 mb-4">
                        <div class="absolute inset-0 border-4 border-red-200 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-red-600 rounded-full border-t-transparent animate-spin"></div>
                    </div>
                    <p class="text-slate-600 font-medium">Loading dashboards...</p>
                </div>
            </div>
        </div>
    </div>
  </div>


  <div id="screen-workspace" class="hidden h-full w-full flex flex-col bg-white">
    <!-- Top Navigation Bar -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
      <nav class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-red-600 rounded flex items-center justify-center">
            <i class="ph ph-sliders text-white text-lg"></i>
          </div>
          <span class="text-xl font-bold text-slate-900">IoT Dashboard</span>
        </div>
        <div class="hidden md:flex items-center gap-8">
          <a href="home.html" class="text-slate-700 hover:text-red-600 font-medium transition">Home</a>
          <a href="features.html" class="text-slate-700 hover:text-red-600 font-medium transition">Features</a>
          <a href="index.html" class="text-red-600 bg-red-50 px-3 py-1 rounded font-medium transition">My Panels</a>
          <a href="contact.html" class="text-slate-700 hover:text-red-600 font-medium transition">Contact</a>
          <a href="login.html" class="ml-4 inline-flex items-center justify-center px-4 py-2 rounded-lg text-sm font-semibold bg-red-600 text-white hover:bg-red-700 transition shadow-sm">
            Login
          </a>
        </div>
      </nav>
    </header>

    <!-- Action Bar -->
    <div class="h-12 bg-white border-b border-slate-200 flex items-center justify-between px-8 shrink-0">
        <!-- Left: Dashboard Name -->
        <div class="flex items-center gap-2">
            <span class="text-sm font-semibold text-slate-900" id="dashboard-name-display">Loading...</span>
        </div>
        
        <!-- Center: Topic ID -->
        <div class="flex items-center gap-2 text-xs text-slate-600">
            <span>Topic ID: <span id="topic-id-display">176675196394000</span></span>
            <button onclick="copyTopicId()" class="text-slate-400 hover:text-slate-600 p-1">
                <i class="ph ph-copy text-sm"></i>
            </button>
        </div>
        
        <!-- Right: Online/Offline Status and Action Buttons -->
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 text-xs" id="connection-status">
                <div class="w-2 h-2 rounded-full bg-red-500" id="status-indicator"></div>
                <span class="text-slate-600" id="status-text">Offline</span>
            </div>
            <div class="flex items-center gap-2">
                <button id="btn-save" onclick="saveCurrentDashboard()" class="hidden px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-semibold transition flex items-center gap-2">
                    <i class="ph ph-floppy-disk"></i> Save
                </button>
                <button onclick="publishDashboard()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold transition flex items-center gap-2">
                    <i class="ph ph-arrow-up"></i> Publish
                </button>
            </div>
        </div>
    </div>

    <div class="flex-1 flex overflow-hidden">
        <!-- Left Sidebar - Widgets Panel -->
        <aside class="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0 z-50">
            <div class="p-4 border-b border-slate-200">
                <h3 class="text-sm font-bold text-slate-900 mb-2">Widgets</h3>
                <p class="text-xs text-slate-500 mb-4">Click or drag widgets to your dashboard</p>
                <div class="relative mb-4">
                    <input type="text" id="widget-search" placeholder="Search widgets..." class="w-full px-3 py-2 pl-9 text-xs border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                </div>
                <div class="flex gap-1 border-b border-slate-200">
                    <button onclick="filterWidgets('all')" class="filter-tab active px-3 py-1.5 text-xs font-medium text-red-600 border-b-2 border-red-600">All Widgets</button>
                    <button onclick="filterWidgets('controls')" class="filter-tab px-3 py-1.5 text-xs font-medium text-slate-600 hover:text-red-600">Controls</button>
                    <button onclick="filterWidgets('visualizat')" class="filter-tab px-3 py-1.5 text-xs font-medium text-slate-600 hover:text-red-600">Visualizat</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4">
                <div id="mqtt-status" class="px-3 py-2 rounded bg-slate-50 border border-slate-200 text-xs flex items-center gap-2 text-red-600 mb-4">
            <div class="w-2 h-2 rounded-full bg-red-500"></div> Disconnected
          </div>

                <div id="widget-palette" class="space-y-2">
                    <div class="widget-item" data-category="visualizat">
                        <button onclick="addWidget('gauge180')" class="w-full flex items-start gap-3 p-3 bg-slate-50 hover:bg-red-50 rounded-lg border border-slate-200 hover:border-red-200 text-left transition group">
                            <i class="ph ph-gauge text-red-600 text-lg mt-0.5"></i>
                            <div class="flex-1">
                                <div class="text-sm font-semibold text-slate-900 group-hover:text-red-600">Gauge</div>
                                <div class="text-xs text-slate-500">Display values with visual indicators</div>
                            </div>
                        </button>
                    </div>
                    <div class="widget-item" data-category="visualizat">
                        <button onclick="addWidget('gauge360')" class="w-full flex items-start gap-3 p-3 bg-slate-50 hover:bg-red-50 rounded-lg border border-slate-200 hover:border-red-200 text-left transition group">
                            <i class="ph ph-timer text-red-600 text-lg mt-0.5"></i>
                            <div class="flex-1">
                                <div class="text-sm font-semibold text-slate-900 group-hover:text-red-600">360Â° Gauge</div>
                                <div class="text-xs text-slate-500">Full circle gauge display</div>
                            </div>
                        </button>
                    </div>
                    <div class="widget-item" data-category="visualizat">
                        <button onclick="addWidget('linechart')" class="w-full flex items-start gap-3 p-3 bg-slate-50 hover:bg-red-50 rounded-lg border border-slate-200 hover:border-red-200 text-left transition group">
                            <i class="ph ph-chart-bar text-red-600 text-lg mt-0.5"></i>
                            <div class="flex-1">
                                <div class="text-sm font-semibold text-slate-900 group-hover:text-red-600">Chart</div>
                                <div class="text-xs text-slate-500">Data visualization and analytics</div>
                            </div>
                        </button>
                    </div>
                    <div class="widget-item" data-category="controls">
                        <button onclick="addWidget('slideswitch')" class="w-full flex items-start gap-3 p-3 bg-slate-50 hover:bg-red-50 rounded-lg border border-slate-200 hover:border-red-200 text-left transition group">
                            <i class="ph ph-toggle-left text-red-600 text-lg mt-0.5"></i>
                            <div class="flex-1">
                                <div class="text-sm font-semibold text-slate-900 group-hover:text-red-600">Toggle</div>
                                <div class="text-xs text-slate-500">On/off control switches</div>
                            </div>
                        </button>
                    </div>
                    <div class="widget-item" data-category="controls">
                        <button onclick="addWidget('slider')" class="w-full flex items-start gap-3 p-3 bg-slate-50 hover:bg-red-50 rounded-lg border border-slate-200 hover:border-red-200 text-left transition group">
                            <i class="ph ph-sliders-horizontal text-red-600 text-lg mt-0.5"></i>
                            <div class="flex-1">
                                <div class="text-sm font-semibold text-slate-900 group-hover:text-red-600">Slider</div>
                                <div class="text-xs text-slate-500">Range control input</div>
                            </div>
                        </button>
                    </div>
                    <div class="widget-item" data-category="controls">
                        <button onclick="addWidget('pushbutton')" class="w-full flex items-start gap-3 p-3 bg-slate-50 hover:bg-red-50 rounded-lg border border-slate-200 hover:border-red-200 text-left transition group">
                            <i class="ph ph-radio-button text-rose-600 text-lg mt-0.5"></i>
                            <div class="flex-1">
                                <div class="text-sm font-semibold text-slate-900 group-hover:text-red-600">Push Button</div>
                                <div class="text-xs text-slate-500">Momentary action button</div>
                            </div>
                        </button>
                    </div>
                    <div class="widget-item" data-category="controls">
                        <button onclick="addWidget('tactswitch')" class="w-full flex items-start gap-3 p-3 bg-slate-50 hover:bg-red-50 rounded-lg border border-slate-200 hover:border-red-200 text-left transition group">
                            <i class="ph ph-hand-tap text-pink-600 text-lg mt-0.5"></i>
                            <div class="flex-1">
                                <div class="text-sm font-semibold text-slate-900 group-hover:text-red-600">Button</div>
                                <div class="text-xs text-slate-500">Tactile switch control</div>
                            </div>
                        </button>
                    </div>
                    <div class="widget-item" data-category="visualizat">
                        <button onclick="addWidget('led')" class="w-full flex items-start gap-3 p-3 bg-slate-50 hover:bg-red-50 rounded-lg border border-slate-200 hover:border-red-200 text-left transition group">
                            <i class="ph ph-lightbulb text-red-600 text-lg mt-0.5"></i>
                            <div class="flex-1">
                                <div class="text-sm font-semibold text-slate-900 group-hover:text-red-600">LED</div>
                                <div class="text-xs text-slate-500">Status indicator light</div>
                            </div>
                        </button>
                    </div>
                    <div class="widget-item" data-category="visualizat">
                        <button onclick="addWidget('label')" class="w-full flex items-start gap-3 p-3 bg-slate-50 hover:bg-red-50 rounded-lg border border-slate-200 hover:border-red-200 text-left transition group">
                            <i class="ph ph-text-t text-slate-600 text-lg mt-0.5"></i>
                            <div class="flex-1">
                                <div class="text-sm font-semibold text-slate-900 group-hover:text-red-600">Label</div>
                                <div class="text-xs text-slate-500">Text display widget</div>
                            </div>
                        </button>
                    </div>
                    <div class="widget-item" data-category="visualizat">
                        <button onclick="addWidget('map')" class="w-full flex items-start gap-3 p-3 bg-slate-50 hover:bg-red-50 rounded-lg border border-slate-200 hover:border-red-200 text-left transition group">
                            <i class="ph ph-map-trifold text-red-600 text-lg mt-0.5"></i>
                            <div class="flex-1">
                                <div class="text-sm font-semibold text-slate-900 group-hover:text-red-600">Map</div>
                                <div class="text-xs text-slate-500">Geographic location display</div>
                            </div>
                        </button>
                    </div>
                    <div class="widget-item" data-category="controls">
                        <button onclick="addWidget('input')" class="w-full flex items-start gap-3 p-3 bg-slate-50 hover:bg-red-50 rounded-lg border border-slate-200 hover:border-red-200 text-left transition group">
                            <i class="ph ph-keyboard text-red-600 text-lg mt-0.5"></i>
                            <div class="flex-1">
                                <div class="text-sm font-semibold text-slate-900 group-hover:text-red-600">Input</div>
                                <div class="text-xs text-slate-500">Text input control</div>
                            </div>
                        </button>
                    </div>
          </div>
        </div>
    </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col h-full overflow-hidden bg-slate-50 relative">
            <div class="flex-1 overflow-y-auto p-6">
                <div class="bg-white rounded-lg border border-slate-200 p-6 min-h-full">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-slate-900">Dashboard</h3>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-slate-500" id="widget-count">0 widgets</span>
                            <button class="text-slate-400 hover:text-slate-600 p-1">
                                <i class="ph ph-arrows-out text-lg"></i>
                            </button>
                        </div>
                    </div>
                    <div id="dashboard-empty" class="flex flex-col items-center justify-center py-20 text-center">
                        <i class="ph ph-chart-bar text-6xl text-slate-300 mb-4"></i>
                        <p class="text-lg font-semibold text-slate-600 mb-2">No widgets yet</p>
                        <p class="text-sm text-slate-500">Drag widgets from the palette to place them anywhere</p>
                    </div>
                    <div class="grid-stack min-h-[800px] hidden" id="dashboard-grid-container"></div>
                </div>
        </div>
    </main>
    </div>
  </div>

  <div id="config-modal">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-800">Edit Widget</h3><button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i class="ph ph-x text-lg"></i></button></div>
      <div id="modal-fields"></div>
      <div class="mt-6 flex gap-2">
        <button onclick="saveModal()" class="flex-1 bg-red-600 text-white py-2 rounded-md text-sm font-medium hover:bg-red-700">Update</button>
        <button onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-600 py-2 rounded-md text-sm font-medium hover:bg-slate-200">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // --- GLOBALS ---
    let currentDashId = null;
    let isEditMode = false;
    let currentEditId = null;
    
    
    const API = 'api.php?action='; 
    const MQTT_BROKER = "test.mosquitto.org";
    const MQTT_PORT = 8081;
    //const MQTT_TOPIC = "testxyz";
    let currentTopic = null; // <--- ADD THIS to track active subscription
    
    let client;
    const widgetRegistry = new Map();
    const DEFAULT_LOC = { lat: 10.7905, lng: 78.7047 };

    // --- GRID SETUP ---
    let grid;
    
    function initGrid() {
        const container = document.getElementById('dashboard-grid-container');
        if (container) {
            if (grid) {
                grid.destroy();
                grid = null;
            }
            // Ensure container is visible before initializing grid
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
            }
            grid = GridStack.init({ column: 12, cellHeight: 100, margin: 10, float: true, disableResize: true, disableDrag: true, animate: true }, container);
        }
    }
    
    // Helper Functions
    function formatTimeAgo(dateString) {
        if (!dateString) return 'Just now';
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
    }
    
    function formatDateTime(dateString) {
        if (!dateString) return 'Never';
        const date = new Date(dateString);
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        
        // If today, show only time
        if (dateOnly.getTime() === today.getTime()) {
            return `Today at ${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;
        }
        // If yesterday
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        if (dateOnly.getTime() === yesterday.getTime()) {
            return `Yesterday at ${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;
        }
        // Otherwise show full date and time
        return date.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined,
            hour: '2-digit', 
            minute: '2-digit' 
        });
    }
    
    async function copyDashboard(id, e) {
        e.stopPropagation();
        
        try {
            // Fetch the original dashboard
            const res = await fetch(`${API}get_dashboard&id=${id}`);
            if (!res.ok) {
                alert('Failed to load dashboard for copying');
                return;
            }
            
            const originalDash = await res.json();
            const widgets = JSON.parse(originalDash.data || '[]');
            
            // Create new dashboard with copied data
            const newId = 'dash_' + Date.now();
            const newName = originalDash.name + ' (Copy)';
            
            const saveRes = await fetch(`${API}save_dashboard`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    id: newId, 
                    name: newName, 
                    data: widgets 
                })
            });
            
            if (saveRes.ok) {
                // Show success feedback
                const btn = e.target.closest('button');
                if (btn) {
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="ph ph-check text-lg"></i>';
                    btn.classList.remove('text-slate-400', 'hover:text-slate-600');
                    btn.classList.add('text-green-600');
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.classList.remove('text-green-600');
                        btn.classList.add('text-slate-400', 'hover:text-slate-600');
                    }, 1500);
                }
                // Reload the list to show the new dashboard
                setTimeout(() => loadList(), 500);
            } else {
                alert('Failed to copy dashboard');
            }
        } catch (error) {
            console.error('Error copying dashboard:', error);
            alert('Error copying dashboard: ' + error.message);
        }
    }
    
    function copyTopicId() {
        // Get topic ID from action bar display
        const topicIdEl = document.getElementById('topic-id-display');
        const topicId = topicIdEl ? topicIdEl.textContent : currentDashId;
        
        if (topicId && topicId !== '-') {
            navigator.clipboard.writeText(topicId).then(() => {
                // Show visual feedback
                const buttons = document.querySelectorAll('button[onclick="copyTopicId()"]');
                buttons.forEach(btn => {
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="ph ph-check text-xs"></i>';
                    btn.classList.add('text-green-600');
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.classList.remove('text-green-600');
                    }, 1000);
                });
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy Topic ID');
            });
        }
    }
    
    async function publishDashboard() {
        if (!currentDashId) {
            alert("No dashboard selected");
            return;
        }
        
        // First save the dashboard
        await saveCurrentDashboard();
        
        // Switch to published/view mode (read-only with live updates)
        setEditMode(false);
        
        // Disable drag and resize in published mode
        if (grid) {
            grid.disableMove();
            grid.disableResize();
        }
        
        // Hide edit controls (settings and delete buttons)
        document.body.classList.remove('edit-mode');
        
        // Show success message
        const publishBtn = document.querySelector('button[onclick="publishDashboard()"]');
        if (publishBtn) {
            const originalText = publishBtn.innerHTML;
            publishBtn.innerHTML = '<i class="ph ph-check"></i> Published';
            publishBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            publishBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            setTimeout(() => {
                publishBtn.innerHTML = originalText;
                publishBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                publishBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            }, 2000);
        }
        
        // Ensure MQTT is connected and subscribed for live updates
        if (client && client.isConnected() && currentTopic) {
            console.log("Dashboard published. Live updates active on topic:", currentTopic);
        } else {
            console.warn("MQTT not connected. Live updates may not work.");
        }
    }
    
    function filterWidgets(category) {
        // Update active tab
        document.querySelectorAll('.filter-tab').forEach(btn => {
            btn.classList.remove('active', 'text-red-600', 'border-b-2', 'border-red-600');
            btn.classList.add('text-slate-600');
        });
        event.target.classList.add('active', 'text-red-600', 'border-b-2', 'border-red-600');
        event.target.classList.remove('text-slate-600');
        
        // Filter widgets
        const widgets = document.querySelectorAll('.widget-item');
        widgets.forEach(widget => {
            if (category === 'all' || widget.dataset.category === category) {
                widget.style.display = 'block';
            } else {
                widget.style.display = 'none';
            }
        });
    }

    /* ==================== SCREEN 1: LIST LOGIC ==================== */
    async function loadList() {
        document.getElementById('screen-list').classList.remove('hidden');
        document.getElementById('screen-workspace').classList.add('hidden');
        
        const container = document.getElementById('dashboard-grid');
        const loadingState = document.getElementById('loading-state');
        
        // Show loading state
        if (loadingState) {
            loadingState.classList.remove('hidden');
        } else {
            container.innerHTML = `
                <div id="loading-state" class="col-span-full flex flex-col items-center justify-center py-20">
                    <div class="relative w-16 h-16 mb-4">
                        <div class="absolute inset-0 border-4 border-red-200 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-red-600 rounded-full border-t-transparent animate-spin"></div>
                    </div>
                    <p class="text-slate-600 font-medium">Loading dashboards...</p>
                </div>
            `;
        }
        
        try {
            const res = await fetch(`${API}list_dashboards`);
            
            let list = [];
            
            // Parse response
            const responseData = await res.json();
            
            // Check if response contains an error message
            if (responseData && responseData.error) {
                // Database connection errors are real errors - show them
                if (responseData.error.includes('Database') || responseData.error.includes('connection')) {
                    throw new Error(responseData.error);
                }
                // Other errors might just mean no dashboards - treat as empty
                list = [];
            } 
            // If response is an array, use it
            else if (Array.isArray(responseData)) {
                list = responseData;
            } 
            // If response is not an array and not an error object, treat as empty
            else {
                list = [];
            }
            
            container.innerHTML = '';

            // If list is empty, show "No Panels" message (this is NOT an error)
            if(list.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-20">
                        <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mb-4">
                            <i class="ph ph-folder-open text-red-400 text-4xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-900 mb-2">No Panels Found</h3>
                        <p class="text-slate-500 text-sm mb-6 max-w-md text-center">You haven't created any dashboards yet. Create your first panel to get started.</p>
                        <button onclick="createNewDashboard()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2.5 rounded-lg shadow-sm flex items-center gap-2 text-sm font-medium transition">
                            <i class="ph ph-plus text-base"></i> Create New Panel
                        </button>
                    </div>
                `;
            } else {
                // Display dashboards properly
                list.forEach(d => {
                const card = document.createElement('div');
                card.className = "bg-white border border-slate-200 rounded-lg p-6 hover:shadow-md transition-all cursor-pointer group min-w-0";
                card.style.minWidth = '280px';
                card.onclick = (e) => { if(!e.target.closest('.action-btn')) openWorkspace(d.id); };
                
                // Parse widgets to count devices
                let widgetCount = 0;
                let deviceCount = 0;
                try {
                    // Handle both string and already parsed data
                    let widgets;
                    if (typeof d.data === 'string') {
                        widgets = JSON.parse(d.data || '[]');
                    } else {
                        widgets = d.data || [];
                    }
                    widgetCount = Array.isArray(widgets) ? widgets.length : 0;
                    // Count unique channels as devices
                    if (Array.isArray(widgets) && widgets.length > 0) {
                        const channels = new Set(widgets.map(w => w.ch).filter(ch => ch !== undefined));
                        deviceCount = channels.size;
                    }
                } catch(e) {
                    console.warn('Error parsing dashboard data:', e);
                    widgetCount = 0;
                }
                
                const updatedDateTime = d.updated_at ? formatDateTime(d.updated_at) : 'Never';
                
                card.innerHTML = `
                    <div class="mb-4">
                        <h3 class="text-lg font-bold text-slate-900 mb-3 group-hover:text-red-600 transition">${d.name || 'Untitled Dashboard'}</h3>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2 text-sm text-slate-600">
                                <i class="ph ph-stack text-red-500"></i>
                                <span><strong>${widgetCount}</strong> widget${widgetCount !== 1 ? 's' : ''}</span>
                            </div>
                            <div class="flex items-center gap-2 text-xs text-slate-500">
                                <i class="ph ph-clock text-slate-400"></i>
                                <span>Updated: ${updatedDateTime}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-start pt-4 border-t border-slate-100 gap-2 flex-wrap">
                        <button class="action-btn bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-xs font-semibold transition flex items-center gap-1.5 flex-shrink-0" onclick="openWorkspace('${d.id}'); event.stopPropagation();">
                            <i class="ph ph-pencil-simple text-sm"></i>
                            <span>Edit</span>
                        </button>
                        <button class="action-btn bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-lg text-xs font-semibold transition flex items-center gap-1.5 flex-shrink-0" onclick="copyDashboard('${d.id}', event)" title="Copy Panel">
                            <i class="ph ph-copy text-sm"></i>
                            <span>Copy</span>
                        </button>
                        <button class="action-btn bg-red-50 hover:bg-red-100 text-red-600 px-3 py-2 rounded-lg text-xs font-semibold transition flex items-center gap-1.5 flex-shrink-0" onclick="deleteDashboard('${d.id}', event)" title="Delete">
                            <i class="ph ph-trash text-sm"></i>
                            <span>Delete</span>
                        </button>
                    </div>
                `;
                    container.appendChild(card);
                });
            }
        } catch (error) {
            // Only show error for actual failures (network errors, server errors, parsing errors)
            console.error('Error loading dashboards:', error);
            container.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-20">
                    <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mb-4">
                        <i class="ph ph-warning text-red-400 text-4xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-slate-900 mb-2">Error Loading Dashboards</h3>
                    <p class="text-slate-500 text-sm mb-6 max-w-md text-center">There was an error loading your dashboards. Please check your connection and try again.</p>
                    <button onclick="loadList()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2.5 rounded-lg shadow-sm flex items-center gap-2 text-sm font-medium transition">
                        <i class="ph ph-arrow-clockwise text-base"></i> Retry
                    </button>
                </div>
            `;
        }
    }

    async function createNewDashboard() {
        const name = prompt("Dashboard Name:", "Factory Line 1");
        if(!name) return;
        // Generate unique topic ID for this panel
        const newId = 'dash_' + Date.now();
        await fetch(`${API}save_dashboard`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: newId, name: name, data: [] })
        });
        // Open workspace with the unique topic ID
        openWorkspace(newId); // Immediately open the new dashboard
    }

    /* ==================== SCREEN 2: WORKSPACE LOGIC ==================== */
    async function openWorkspace(id) {
        currentDashId = id;
        
        // --- MQTT SUBSCRIPTION SWITCH ---
        if(client && client.isConnected()) {
            if(currentTopic) client.unsubscribe(currentTopic); // Unsub from previous
            currentTopic = id; // Topic is now the Dashboard ID
            client.subscribe(currentTopic);
            console.log("Switched Topic to:", currentTopic);
        }
        // -------------------------------

        // Switch Views
        document.getElementById('screen-list').classList.add('hidden');
        document.getElementById('screen-workspace').classList.remove('hidden');
        
        widgetRegistry.clear();
        setEditMode(true); // Enable Edit Mode by default when opening workspace

        // Load Data
        let dash = null;
        let widgets = [];
        
        // Set topic ID immediately (unique for each panel)
        document.getElementById('topic-id-display').textContent = id;
        
        const res = await fetch(`${API}get_dashboard&id=${id}`);
        if(!res.ok) { 
            // If dashboard doesn't exist, use default name and empty widgets
            const defaultName = id.replace('dash_', 'Dashboard ').replace(/\d+$/, '');
            document.getElementById('dashboard-name-display').innerText = defaultName || 'New Dashboard';
            widgets = [];
        } else {
            dash = await res.json();
            if (dash && dash.name) {
                document.getElementById('dashboard-name-display').innerText = dash.name;
            } else {
                document.getElementById('dashboard-name-display').innerText = 'Untitled Dashboard';
            }
            
            // Populate Grid
            try { 
                // Handle both string and already parsed data
                if (typeof dash.data === 'string') {
                    widgets = JSON.parse(dash.data || '[]');
                } else {
                    widgets = dash.data || [];
                }
                // Ensure widgets is an array
                if (!Array.isArray(widgets)) {
                    widgets = [];
                }
            } catch(e) {
                console.warn('Failed to parse dashboard data:', e);
                widgets = [];
            }
        }
        
        const emptyState = document.getElementById('dashboard-empty');
        const gridContainer = document.getElementById('dashboard-grid-container');
        
        // Initialize grid and populate widgets
        setTimeout(() => {
            // Initialize grid first
            if (!grid) {
                initGrid();
            } else {
                // Clear existing widgets
                grid.removeAll();
            }
            
            // Ensure widget palette is visible
            const palette = document.getElementById('widget-palette');
            if (palette) palette.classList.remove('hidden');
            
            if(widgets && widgets.length > 0) {
                // Hide empty state and show grid container
                if (emptyState) emptyState.classList.add('hidden');
                if (gridContainer) {
                    gridContainer.classList.remove('hidden');
                }
                // Update widget count immediately
                updateWidgetCount(widgets.length);
                
                // Add widgets to grid
                widgets.forEach((item, index) => {
                    const html = getWidgetHTML(item.id, item.type, item.title, item);
                    if (grid) {
                        // Ensure we have valid grid positions
                        const x = item.x !== undefined ? item.x : 0;
                        const y = item.y !== undefined ? item.y : 0;
                        const w = item.w !== undefined ? item.w : 3;
                        const h = item.h !== undefined ? item.h : 3;
                        
                        grid.addWidget({ w, h, x, y, content: html, id: item.id });
                        setTimeout(() => {
                            initWidgetInstance(item.id, item);
                            // Update count after each widget is added
                            if (index === widgets.length - 1) {
                                updateWidgetCount(grid.engine.nodes.length);
                            }
                        }, 50 * (index + 1));
                    }
                });
            } else {
                // Show empty state
                if (emptyState) emptyState.classList.remove('hidden');
                if (gridContainer) gridContainer.classList.add('hidden');
                updateWidgetCount(0);
            }
        }, 200);
    }
    
    function updateWidgetCount(count) {
        document.getElementById('widget-count').textContent = `${count} widget${count !== 1 ? 's' : ''}`;
    }

    function closeWorkspace() {
        // Unsubscribe to stop receiving data for this dashboard
        if(client && client.isConnected() && currentTopic) {
            client.unsubscribe(currentTopic);
            currentTopic = null;
        }

        currentDashId = null;
        loadList(); 
    }

    function setEditMode(enable) {
        isEditMode = enable;
        const palette = document.getElementById('widget-palette');
        const saveBtn = document.getElementById('btn-save');
        const emptyState = document.getElementById('dashboard-empty');
        const gridContainer = document.getElementById('dashboard-grid-container');
        
        if(isEditMode) {
            document.body.classList.add('edit-mode');
            // Keep widget palette visible
            if (palette) palette.classList.remove('hidden');
            if (saveBtn) saveBtn.classList.remove('hidden');
            if (gridContainer) {
                gridContainer.classList.remove('hidden');
                if (emptyState) emptyState.classList.add('hidden');
            }
            if (grid) {
                grid.enableMove(true); 
                grid.enableResize(true);
            }
        } else {
            document.body.classList.remove('edit-mode');
            // Keep widget palette visible even when not in edit mode
            if (palette) palette.classList.remove('hidden');
            if (saveBtn) saveBtn.classList.add('hidden');
            if (grid && grid.engine.nodes.length === 0) {
                if (gridContainer) gridContainer.classList.add('hidden');
                if (emptyState) emptyState.classList.remove('hidden');
            }
            if (grid) {
                grid.enableMove(false); 
                grid.enableResize(false);
            }
        }
    }

    function toggleMode() {
        setEditMode(!isEditMode);
    }

    async function saveCurrentDashboard() {
        if(!currentDashId) {
            alert("No dashboard selected");
            return;
        }
        
        if (!grid) {
            alert("Grid not initialized. Please wait...");
            return;
        }
        
        const saveData = [];
        
        grid.engine.nodes.forEach(node => {
            const id = node.el.getAttribute('gs-id');
            const w = widgetRegistry.get(id);
            
            if(w) {
                // FIX: Only save the specific config properties.
                // Do NOT use { ...w } because it includes 'w.instance' (the heavy chart/map object)
                saveData.push({ 
                    id: w.id,
                    type: w.type,
                    title: w.title,
                    ch: w.ch,
                    unit: w.unit || '',
                    min: w.min || 0,
                    max: w.max || 100,
                    lat: w.lat || 0,
                    lng: w.lng || 0,
                    // GridStack Position Data
                    x: node.x, 
                    y: node.y, 
                    w: node.w, 
                    h: node.h 
                });
            }
        });

        const currentName = document.getElementById('dashboard-name-display').innerText;
        
        try {
            const res = await fetch(`${API}save_dashboard`, {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: currentDashId, name: currentName, data: saveData })
            });

            if(res.ok) {
                const result = await res.json();
                // Show success feedback
                const saveBtn = document.getElementById('btn-save');
                if (saveBtn) {
                    const originalText = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<i class="ph ph-check"></i> Saved';
                    saveBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    setTimeout(() => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        saveBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    }, 2000);
                }
                setEditMode(false); // Exit edit mode
            } else {
                const errorText = await res.text();
                alert("Error Saving: " + errorText);
            }
        } catch (e) {
            console.error(e);
            alert("Save Failed: " + e.message);
        }
    }

    async function deleteDashboard(id, e) {
        e.stopPropagation();
        if(!confirm("Delete this dashboard?")) return;
        await fetch(`${API}delete_dashboard&id=${id}`, { method: 'DELETE' });
        loadList();
    }

    /* ==================== WIDGET & MQTT LOGIC (Same as before) ==================== */
    function getWidgetHTML(id, type, title, config) {
        const { ch=0, unit='', min=0, max=100 } = config;
        let c = '';
        if (type.includes('gauge') || type === 'linechart') c = `<div id="${id}_chart" class="w-full h-full"></div>`;
        else if (type === 'map') c = `<div id="${id}_map" class="w-full h-full z-0"></div>`;
        else if (type === 'slider') c = `<div class="flex flex-col items-center justify-center h-full w-full px-[5cqmin] relative"><input type="range" id="${id}_input" min="${min}" max="${max}" class="w-full appearance-none bg-transparent cursor-pointer z-10" style="height: 15cqmin;" onchange="publishData('${id}', this.value)" oninput="handleLocalInput('${id}', this.value)"><div class="absolute w-[90%] h-[6cqmin] bg-slate-300 rounded-full shadow-[inset_0_2px_4px_rgba(0,0,0,0.3)] border-b border-slate-100 top-1/2 -translate-y-1/2 z-0"></div><style> #${id}_input::-webkit-slider-thumb { -webkit-appearance: none; height: 22cqmin; width: 14cqmin; border-radius: 6px; background: linear-gradient(to bottom, #f8fafc 0%, #cbd5e1 100%); border: 1px solid #94a3b8; box-shadow: 0 6px 10px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.8); margin-top: -8cqmin; background-image: repeating-linear-gradient(90deg, transparent, transparent 20%, #94a3b8 20%, #94a3b8 40%); background-size: 50% 40%; background-position: center; background-repeat: no-repeat; } </style><div class="flex justify-between w-full mt-[8cqmin] font-mono text-slate-500 font-bold" style="font-size: 7cqmin; line-height: 1;"><span id="${id}_min_lbl" class="text-slate-400">${min}</span><div class="bg-slate-800 text-emerald-400 px-2 rounded border border-slate-600 shadow-inner flex items-center"><span id="${id}_val" style="font-size: 9cqmin;">0</span></div><span id="${id}_max_lbl" class="text-slate-400">${max}</span></div></div>`;
        else if (type === 'slideswitch') c = `<div class="flex flex-col items-center justify-center h-full gap-[3cqmin]"><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="${id}_input" class="sr-only peer" onchange="publishData('${id}', this.checked ? 1 : 0)"><div class="bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:bg-red-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:bg-white after:border-gray-300 after:border after:rounded-full after:transition-all after:shadow-sm shadow-inner" style="width: 50cqmin; height: 28cqmin; --handle-size: 22cqmin; --handle-pad: 3cqmin;"></div><style> #${id}_input ~ div::after { height: var(--handle-size); width: var(--handle-size); top: var(--handle-pad); left: var(--handle-pad); } #${id}_input:checked ~ div::after { transform: translateX(22cqmin) !important; } </style></label><span class="font-bold text-slate-400 uppercase tracking-wider" style="font-size: 10cqmin;">Toggle</span></div>`;
        else if (type === 'tactswitch') c = `<div class="flex flex-col items-center justify-center h-full"><button id="${id}_btn" class="tact-btn rounded-full text-slate-500 flex items-center justify-center transition-all duration-100 active:!bg-rose-500 active:!bg-none active:text-white active:shadow-[inset_0_4px_8px_rgba(0,0,0,0.3)]" style="width: 55cqmin; height: 55cqmin;" onmousedown="publishData('${id}', 1)" onmouseup="publishData('${id}', 0)" onmouseleave="publishData('${id}', 0)"><i class="ph ph-power" style="font-size: 28cqmin; font-weight: bold;"></i></button></div>`;
        else if (type === 'pushbutton') c = `<div class="flex flex-col items-center justify-center h-full"><button id="${id}_btn" class="btn-push rounded text-slate-600 font-bold uppercase tracking-widest border border-slate-300" style="width: 70cqw; height: 30cqh; font-size: 10cqmin;" onclick="togglePush('${id}')">OFF</button></div>`;
        else if (type === 'led') c = `<div class="flex flex-col items-center justify-center h-full"><div class="bg-slate-100 rounded-lg shadow-inner border border-slate-200 flex items-center justify-center" style="padding: 5cqmin;"><div id="${id}_led" class="led-bulb" style="width: 35cqmin; height: 35cqmin;"></div></div></div>`;
        else if (type === 'rgb') c = `<div class="flex items-center justify-center h-full"><div class="bg-white rounded-full shadow-md border border-slate-100 p-[1cqmin]"><div id="${id}_rgb" class="rounded-full bg-slate-200 shadow-inner border border-slate-300 transition-colors duration-300 flex items-center justify-center" style="width: 45cqmin; height: 45cqmin;"><i class="ph ph-lightbulb text-white/50 drop-shadow-md" style="font-size: 25cqmin;"></i></div></div></div>`;
        else if (type === 'label') c = `<div class="flex flex-col items-center justify-center h-full w-full px-4"><div class="lcd-screen w-full flex items-center justify-end px-3" style="height: 40cqh;"><span id="${id}_val" class="tracking-widest" style="font-size: 25cqh; line-height: 1;">00.0</span><span id="${id}_unit" class="ml-1 opacity-70" style="font-size: 10cqh; margin-top: 10cqh;">${unit}</span></div></div>`;
        else if (type === 'terminal') c = `<div id="${id}_term" class="terminal-log">System Ready...<br></div>`;
        else if (type === 'input') {
    c = `
      <div class="flex flex-col items-center justify-center h-full w-full px-4 gap-2">
        
        <div class="flex w-full shadow-sm rounded-md overflow-hidden border border-slate-300">
            <input type="text" id="${id}_txt" 
                   placeholder="Enter value..." 
                   class="w-full px-3 py-2 bg-slate-50 text-slate-700 text-sm outline-none focus:bg-white focus:inner-shadow transition font-mono"
                   onkeydown="if(event.key==='Enter') handleSendInput('${id}')">
            
            <button onclick="handleSendInput('${id}')" 
                    class="bg-red-600 hover:bg-red-700 text-white px-4 flex items-center justify-center transition active:bg-red-800 border-l border-red-800">
                <i class="ph ph-paper-plane-right text-lg"></i>
            </button>
        </div>

        <div class="text-[10px] text-slate-400 font-mono tracking-tight flex w-full justify-between">
            <span>CH: ${ch}</span>
            <span>Sent: <span id="${id}_last" class="text-red-600 font-bold">-</span></span>
        </div>

      </div>`;
  }

        return `<div class="grid-stack-item-content"><div class="widget-header"><span class="widget-title" id="${id}_title_disp">${title}</span><div class="edit-tools"><button onclick="openSettings('${id}')" class="text-slate-400 hover:text-red-600 p-1"><i class="ph ph-gear text-lg"></i></button><button onclick="deleteWidget(this)" class="text-slate-400 hover:text-red-500 p-1"><i class="ph ph-trash text-lg"></i></button></div></div><div class="widget-body">${c}</div></div>`;
    }

    function initWidgetInstance(id, config) {
        const el = document.getElementById(`${id}_chart`);
        const w = { ...config, dataHistory: config.dataHistory || [] };
        if (w.type.includes('gauge') && el) { w.instance = echarts.init(el); renderGauge(w, 0); new ResizeObserver(() => w.instance.resize()).observe(el); }
        else if (w.type === 'linechart' && el) { w.instance = echarts.init(el); w.instance.setOption({ grid: { top: 10, bottom: 20, left: 30, right: 10 }, xAxis: { type: 'category', show: false }, yAxis: { type: 'value', splitLine: { lineStyle: { color: '#f1f5f9' } } }, series: [{ type: 'line', data: [], smooth: true, showSymbol: false, itemStyle: { color: '#06b6d4' }, areaStyle: { color: '#ecfeff' } }] }); new ResizeObserver(() => w.instance.resize()).observe(el); }
        else if (w.type === 'map') { const mapEl = document.getElementById(`${id}_map`); if (mapEl) { const map = L.map(mapEl, { zoomControl: false, attributionControl: false }).setView([w.lat, w.lng], 13); L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map); w.marker = L.marker([w.lat, w.lng]).addTo(map); w.instance = map; new ResizeObserver(() => map.invalidateSize()).observe(mapEl); } }
        widgetRegistry.set(id, w);
    }
    function renderGauge(w, val) {
        if(!w.instance) return; const is360 = w.type === 'gauge360';
        w.instance.setOption({ series: [{ type: 'gauge', radius: '90%', center: ['50%', '55%'], startAngle: is360 ? 90 : 180, endAngle: is360 ? -269.9 : 0, min: w.min, max: w.max, pointer: { show: is360, itemStyle: { color: '#6366f1' } }, progress: { show: true, width: 14, itemStyle: { color: is360 ? '#fbbf24' : '#6366f1' } }, axisLine: { lineStyle: { width: 14, color: [[1, '#f1f5f9']] } }, axisTick: { show: false }, splitLine: { show: false }, axisLabel: { show: false }, detail: { formatter: (v) => `${parseFloat(v).toFixed(1)}\n${w.unit}`, fontSize: 14, offsetCenter: [0, '35%'], color: '#475569', lineHeight: 18 }, data: [{ value: val }] }] });
    }

    function initMQTT() {
        const clientId = "scada_" + Math.random().toString(16).substr(2, 8);
        client = new Paho.MQTT.Client(MQTT_BROKER, Number(MQTT_PORT), clientId);

        client.onConnectionLost = (resp) => {
            console.log("MQTT Lost");
            document.getElementById("mqtt-status").innerHTML = `<div class="w-2 h-2 rounded-full bg-red-500"></div> Disconnected`;
            document.getElementById("mqtt-status").classList.remove("text-red-600");
            document.getElementById("mqtt-status").classList.add("text-red-600");
            
            // Update connection status in action bar
            const statusIndicator = document.getElementById("status-indicator");
            const statusText = document.getElementById("status-text");
            if (statusIndicator) {
                statusIndicator.classList.remove("bg-green-500", "animate-pulse");
                statusIndicator.classList.add("bg-red-500");
            }
            if (statusText) {
                statusText.textContent = "Offline";
                statusText.classList.remove("text-green-600");
                statusText.classList.add("text-slate-600");
            }
            
            setTimeout(initMQTT, 5000);
        };

        client.onMessageArrived = (message) => {
            try { updateWidgets(JSON.parse(message.payloadString)); } catch (e) {}
        };

        const connectOptions = {
            onSuccess: () => {
                document.getElementById("mqtt-status").innerHTML = `<div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div> Connected`;
                document.getElementById("mqtt-status").classList.remove("text-red-600");
                document.getElementById("mqtt-status").classList.add("text-red-600");
                console.log("MQTT Connected");
                
                // Update connection status in action bar
                const statusIndicator = document.getElementById("status-indicator");
                const statusText = document.getElementById("status-text");
                if (statusIndicator) {
                    statusIndicator.classList.remove("bg-red-500");
                    statusIndicator.classList.add("bg-green-500", "animate-pulse");
                }
                if (statusText) {
                    statusText.textContent = "Online";
                    statusText.classList.remove("text-slate-600");
                    statusText.classList.add("text-green-600");
                }
                
                // If a dashboard is already open (e.g. after reload), subscribe to it immediately
                if(currentDashId) {
                    currentTopic = currentDashId;
                    client.subscribe(currentTopic);
                    console.log("Subscribed to:", currentTopic);
                }
            },
            onFailure: (e) => { 
                console.log("Conn Failed", e); 
                
                // Update connection status in action bar
                const statusIndicator = document.getElementById("status-indicator");
                const statusText = document.getElementById("status-text");
                if (statusIndicator) {
                    statusIndicator.classList.remove("bg-green-500", "animate-pulse");
                    statusIndicator.classList.add("bg-red-500");
                }
                if (statusText) {
                    statusText.textContent = "Offline";
                    statusText.classList.remove("text-green-600");
                    statusText.classList.add("text-slate-600");
                }
                
                setTimeout(initMQTT, 5000); 
            },
            useSSL: true
        };
        client.connect(connectOptions);
    }
    function updateWidgets(data) {
        widgetRegistry.forEach(w => {
            const val = data[w.ch]; if (val === undefined) return;
            if (w.type.includes('gauge')) renderGauge(w, parseFloat(val));
            else if (w.type === 'linechart') { w.dataHistory.push(val); if (w.dataHistory.length > 30) w.dataHistory.shift(); w.instance.setOption({ series: [{ data: w.dataHistory }] }); }
            else if (w.type === 'label') { const el = document.getElementById(`${w.id}_val`); if(el) el.innerText = typeof val === 'number' ? val.toFixed(1) : val; }
            else if (w.type === 'led') { const el = document.getElementById(`${w.id}_led`); if(val == 1 || val == "1" || val == true) el.classList.add('led-on'); else el.classList.remove('led-on'); }
            else if (w.type === 'rgb') {
                const el = document.getElementById(`${w.id}_rgb`);
                if (val === 0 || val === '0' || val === 'off' || val === false) { el.style.backgroundColor = '#e2e8f0'; el.style.boxShadow = 'inset 0 2px 5px rgba(0,0,0,0.1)'; el.querySelector('i').style.color = 'rgba(255,255,255,0.5)'; el.querySelector('i').style.textShadow = 'none'; } 
                else { el.style.backgroundColor = val; el.style.boxShadow = `0 0 15px ${val}, inset 0 2px 5px rgba(255,255,255,0.4)`; el.querySelector('i').style.color = '#ffffff'; el.querySelector('i').style.textShadow = `0 0 5px ${val}`; }
            }
            else if (w.type === 'map' && typeof val === 'string' && val.includes(',')) { const [lat, lng] = val.split(',').map(Number); w.instance.setView([lat, lng], 13); w.marker.setLatLng([lat, lng]); }
            else if (w.type === 'terminal') { const t = document.getElementById(`${w.id}_term`); t.innerHTML += `<div>> [CH${w.ch}] ${val}</div>`; t.scrollTop = t.scrollHeight; }
        });
    }
    
    function handleSendInput(id) {
    const inputEl = document.getElementById(`${id}_txt`);
    const val = inputEl.value;
    
    // Prevent sending empty data
    if(val.trim() === '') return;

    // Publish to MQTT
    publishData(id, val);

    // Update the "Sent" label for visual feedback
    const lastEl = document.getElementById(`${id}_last`);
    if(lastEl) lastEl.innerText = val;
    
    // Optional: visual flash on the input to confirm send
    inputEl.style.backgroundColor = "#fee2e2"; // flash green
    setTimeout(() => { inputEl.style.backgroundColor = ""; }, 200);
}


    function publishData(id, value) {
        if (!client || !client.isConnected()) return;
        const w = widgetRegistry.get(id);
        
        // Use currentDashId as the topic
        if (w && currentDashId) {
            const message = new Paho.MQTT.Message(JSON.stringify({ [w.ch]: value }));
            message.destinationName = currentDashId; // <--- Send to Dash ID
            client.send(message);
        }
    }

    // Helpers & Modal
    function addWidget(type) {
        if (!isEditMode) {
            setEditMode(true);
        }
        
        // Ensure grid is initialized
        if (!grid) {
            initGrid();
        }
        
        const id = `w_${Date.now()}`;
        let w=3, h=3, title="Widget";
        if(type.includes('gauge')) { title="Pressure"; w=3; h=3; }
        if(type === 'linechart') { title="Trend"; w=6; h=4; }
        if(type === 'slider') { title="Level Set"; h=2; }
        if(type === 'slideswitch') { title="Pump SW"; w=2; h=2; }
        if(type === 'tactswitch' || type === 'pushbutton') { title="Control"; w=2; h=2; }
        if(type === 'led' || type === 'rgb') { title="Status"; w=2; h=2; }
        if(type === 'label') { title="Voltage"; w=2; h=2; }
        if(type === 'terminal') { title="SysLog"; w=5; h=3; }
        if(type === 'map') { title="Location"; w=5; h=4; }
        if(type === 'input') { title="Input"; w=4; h=2; }
        const config = { id, type, title, ch: 0, min: 0, max: 100, unit: '', lat: DEFAULT_LOC.lat, lng: DEFAULT_LOC.lng, dataHistory: [] };
        
        const emptyState = document.getElementById('dashboard-empty');
        const gridContainer = document.getElementById('dashboard-grid-container');
        
        // Show grid container and hide empty state
        if (emptyState) emptyState.classList.add('hidden');
        if (gridContainer) {
            gridContainer.classList.remove('hidden');
        }
        
        // Add widget to grid
        if (grid) {
            try {
                grid.addWidget({ w, h, content: getWidgetHTML(id, type, title, config), id });
                setTimeout(() => {
                    initWidgetInstance(id, config);
                    updateWidgetCount(grid.engine.nodes.length);
                }, 50);
            } catch (error) {
                console.error('Error adding widget to grid:', error);
                // Retry grid initialization if adding widget fails
                initGrid();
                setTimeout(() => {
                    grid.addWidget({ w, h, content: getWidgetHTML(id, type, title, config), id });
                    initWidgetInstance(id, config);
                    updateWidgetCount(grid.engine.nodes.length);
                }, 100);
            }
        } else {
            console.error('Grid not initialized');
            // Initialize grid and retry
            initGrid();
            setTimeout(() => {
                if (grid) {
                    grid.addWidget({ w, h, content: getWidgetHTML(id, type, title, config), id });
                    initWidgetInstance(id, config);
                    updateWidgetCount(grid.engine.nodes.length);
                }
            }, 100);
        }
    }
    function openSettings(id) {
        currentEditId = id; const w = widgetRegistry.get(id); const c = document.getElementById('modal-fields'); c.innerHTML = '';
        c.innerHTML += `<div class="form-group w-full"><label class="form-label">Name</label><input type="text" id="inp_title" value="${w.title}" class="form-input"></div>`;
        c.innerHTML += `<div class="form-group w-full"><label class="form-label">Channel ID</label><input type="number" id="inp_ch" value="${w.ch}" class="form-input"></div>`;
        if(['gauge360','gauge180','slider','label'].includes(w.type)) c.innerHTML += `<div class="form-group w-full"><label class="form-label">Unit</label><input type="text" id="inp_unit" value="${w.unit}" class="form-input"></div>`;
        if(['gauge360','gauge180','slider'].includes(w.type)) c.innerHTML += `<div class="flex gap-2"><div class="form-group w-full"><label class="form-label">Min</label><input type="number" id="inp_min" value="${w.min}" class="form-input"></div><div class="form-group w-full"><label class="form-label">Max</label><input type="number" id="inp_max" value="${w.max}" class="form-input"></div></div>`;
        if(w.type === 'map') c.innerHTML += `<div class="flex gap-2"><div class="form-group w-full"><label class="form-label">Lat</label><input type="number" id="inp_lat" value="${w.lat}" step="any" class="form-input"></div><div class="form-group w-full"><label class="form-label">Lng</label><input type="number" id="inp_lng" value="${w.lng}" step="any" class="form-input"></div></div>`;
        document.getElementById('config-modal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('config-modal').style.display = 'none'; }
    function saveModal() {
        const w = widgetRegistry.get(currentEditId);
        if(document.getElementById('inp_title')) w.title = document.getElementById('inp_title').value;
        if(document.getElementById('inp_ch')) w.ch = parseInt(document.getElementById('inp_ch').value) || 0;
        if(document.getElementById('inp_unit')) w.unit = document.getElementById('inp_unit').value;
        if(document.getElementById('inp_min')) w.min = parseFloat(document.getElementById('inp_min').value);
        if(document.getElementById('inp_max')) w.max = parseFloat(document.getElementById('inp_max').value);
        if(document.getElementById('inp_lat')) w.lat = parseFloat(document.getElementById('inp_lat').value);
        if(document.getElementById('inp_lng')) w.lng = parseFloat(document.getElementById('inp_lng').value);
        document.getElementById(`${currentEditId}_title_disp`).innerText = w.title;
        if(w.type.includes('gauge')) renderGauge(w, 0);
        if(w.type === 'label') { const unitEl = document.getElementById(`${currentEditId}_unit`); if(unitEl) unitEl.innerText = w.unit; }
        if(w.type === 'slider') { const rangeInput = document.getElementById(`${currentEditId}_input`); if(rangeInput) { rangeInput.min = w.min; rangeInput.max = w.max; } const minLabel = document.getElementById(`${currentEditId}_min_lbl`); if(minLabel) minLabel.innerText = w.min; const maxLabel = document.getElementById(`${currentEditId}_max_lbl`); if(maxLabel) maxLabel.innerText = w.max; }
        if(w.type === 'map' && w.instance) { w.instance.setView([w.lat, w.lng], 13); w.marker.setLatLng([w.lat, w.lng]); }
        closeModal();
    }
    function handleLocalInput(id, val) { const el = document.getElementById(`${id}_val`); if(el) el.innerText = val; }
    function togglePush(id) { const btn = document.getElementById(`${id}_btn`); btn.classList.toggle('btn-active-state'); btn.classList.toggle('btn-active-color'); const isActive = btn.classList.contains('btn-active-state'); btn.innerText = isActive ? "ON" : "OFF"; publishData(id, isActive ? 1 : 0); }
    function deleteWidget(btn) { 
        const item = btn.closest('.grid-stack-item'); 
        grid.removeWidget(item); 
        widgetRegistry.delete(item.getAttribute('gs-id'));
        updateWidgetCount(grid.engine.nodes.length);
        if (grid.engine.nodes.length === 0) {
            const emptyState = document.getElementById('dashboard-empty');
            const gridContainer = document.getElementById('dashboard-grid-container');
            if (emptyState) emptyState.classList.remove('hidden');
            if (gridContainer) gridContainer.classList.add('hidden');
        }
    }

    // Widget search functionality
    function initWidgetSearch() {
        const searchInput = document.getElementById('widget-search');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const widgets = document.querySelectorAll('.widget-item');
                widgets.forEach(widget => {
                    const text = widget.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        widget.style.display = 'block';
                    } else {
                        widget.style.display = 'none';
                    }
                });
            });
        }
    }

    window.addEventListener('DOMContentLoaded', () => { 
        loadList(); 
        initMQTT();
        initGrid();
        initWidgetSearch();
    });
</script>
</body>
</html>